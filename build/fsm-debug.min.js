DEBUG=!0,
/**
 * @license
 * The MIT License (MIT)
 *
 * Copyright (c) Joel F Guillod <joel.guillod@gmail.com> (www.imed.ch)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
function(t){"use strict";if("function"==typeof bootstrap)bootstrap("jsfsm",t);else if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else{if("undefined"==typeof self)throw"This environment was not anticipated by imed-javascript-finite-state-machine. Please file a bug.";self.FSM=t()}}(function(){"use strict";var t=function(t,r){var o,i,s=this,a=this._transitions={},c=this._states={},f=this._fromStates={},l=t._,u=this._private=Object.assign({initial:"none"},l);this.debug=u.debug,u.justListen=!1!==u.justListen,this._listeners=[],this.e={},this.original=function(){return s},Object.freeze(this.original),Object.getOwnPropertyNames(t).forEach(function(n){o=t[n],"_"!=n&&(o.entry||o.exit||o.actions?(c[n]=o,!o.exit||o.exit instanceof Array||(o.exit=[o.exit]),!o.entry||o.entry instanceof Array||(o.entry=[o.entry]),o.hasOwnProperty("actions")||(o.actions={})):(a[n]=o instanceof Array?o:[o],this.e[n]||(this.e[n]=e(this,n))))},this),Object.getOwnPropertyNames(a).forEach(function(t){a[t].forEach(function(e){!e.before||e.before instanceof Array||(e.before=[e.before]),!e.after||e.after instanceof Array||(e.after=[e.after]),!e.do||e.do instanceof Array||(e.do=[e.do]),!e.guard||e.guard instanceof Array||(e.guard=[e.guard]),!e.dont||e.dont instanceof Array||(e.dont=[e.dont]),e.from&&!c[e.from]&&(c[e.from]={}),e.to&&!c[e.to]&&(c[e.to]={}),i=e.from||"none",f[i]||(f[i]={}),f[i][t]=e,Object.freeze(e),Object.freeze(f[i][t]),Object.freeze(c[e.from]),Object.freeze(c[e.to])})},this),Object.freeze(a),Object.freeze(c),Object.freeze(f),Object.freeze(u),Object.freeze(this.e),this._pendingTransition=!1,this._lockKey=null,this._lifeCycle=[],n(this,u.initial),this.logger("‚ìÇÔ∏è MACHINE INSTANCIATED",this),"function"==typeof r&&r.call(this,this)};function e(t,e){return function(n){for(var r=0,o=arguments.length,i=new Array(o);r<o;++r)i[r]=arguments[r];return t.trigger.apply(t,[e].concat(i))}}function n(t,e,n){if(t._addHistory(e,n),t._current=e,!t._states.hasOwnProperty(e))throw'unknown state "'+e+"'";t._actions=Object.assign({},t._states[e].actions)}function r(t,e,n,r){var o=n.guard;t.logger("‚ùì GUARD in availEvents | event ‚Äú%s‚Äù | transition",e,n);var i={step:"guard",event:e,from:n.from,to:n.to,options:n.options};return!o||o.every(function(e){return!e||e.apply(t,[i].concat(r))})}return Object.defineProperty(t.prototype,"actions",{get(){return this._actions}}),t.prototype.factory=function(t,r){var o=Object.getOwnPropertyNames(this.e),i=this._private.initial;function s(t,r){1===arguments.length&&"function"==typeof t&&(cb=t,t=null),this._debug=!1,this._pendingTransition=!1,this._listeners=[],this._lockKey=null,this._lifeCycle=[],this._initial="",this.reason=null,n(this,t||i),this.e={},o.forEach(function(t){this.e[t]=e(this,t)},this),Object.freeze(this.e),"function"==typeof r&&r.call(this,this)}return s.prototype=this,new s(t,r)},t.prototype.resetMachine=function(t){if(this.isLocked()&&!this.testLock(t))throw"Reseting machine is forbidden by a lock";if(this._pendingTransition)throw"Reseting machine is forbidden during a transition";n(this,this._private.initial)},t.prototype.engineVersion=function(){return"JFG's FSM engine v 0.8.1 Tue Feb 16 2016 13:02:36 GMT+0100 (CET)"},t.prototype.version=function(){return this._private.version||"unknown"},t.prototype.lock=function(){if(this.isLocked())throw"Machine is already locked";return this._lockKey=arguments[0]||{}},t.prototype.unlock=function(t){return this._lockKey&&t===this._lockKey&&(this._lockKey=null),null===this._lockKey},t.prototype.testLock=function(t){return t===this._lockKey},t.prototype.isLocked=function(){return null!==this._lockKey},t.prototype.status=function(){var t={engine:this.engineVersion(),version:this.version(),state:this._current,pending:this._pendingTransition};return this._private.namespace&&(t.namespace=this._private.namespace),t},t.prototype.current=function(){return this._current},t.prototype._addHistory=function(t,e){var n={date:new Date,to:t};this._current&&(n.from=this._current),e&&(n.event=e),Object.freeze(n),this._lifeCycle.push(n)},t.prototype.history=function(){return this._lifeCycle.concat()},t.prototype.on=function(t,e,n){var r=3,o=n;"function"==typeof e&&(o=e,e=this,r=2);for(var i=arguments.length,s=[];r<i;++r)s.push(arguments[r]);return function(t,e,n,r,o){var i={fn:r,scope:n};return o.length>0&&(i.options=o,t.logger('Add a listener for "%s" with options',e,o,arguments)),t._listeners.length+1===t._listeners.push({pattern:e,observer:i})}(this,t,e,o,s)},t.prototype.un=function(t,e,n){var r=n;return"function"==typeof e&&(r=e,e=this),function(t,e,n,r){var o=t._listeners.length;return t._listeners=t._listeners.filter(function(t){var o=t.observer.fn,i=t.observer.scope;return t.pattern!=e.toString()||n!==i||r!==o}),o>t._listeners.length}(this,t,e,r)},t.prototype.availActions=function(){return Object.getOwnPropertyNames(this.actions)},t.prototype.availEvents=function(t){for(var e=this._fromStates[this._current],n=this,o=1,i=arguments.length,s=i>o?new Array(i-o):[];o<i;++o)s[o-1]=arguments[o];return Object.getOwnPropertyNames(e).filter(function(o){return!0!==t||r(n,o,e[o],s)})},t.prototype.can=function(t,e){if(0===arguments.length)return!1;for(var n=2,o=arguments.length,i=o>n?new Array(o-n):[];n<o;++n)i[n-2]=arguments[n];return!0===e?r(this,t,this._fromStates[this._current][t],i):this._fromStates[this._current].hasOwnProperty(t)},t.prototype.is=function(t){return this._current===t},t.prototype._fsmListeners=function(t,e){var n,r=this,o=this._private.justListen,i=t.event,s=t.to,a=t.from,c=t.state,f=t.step+(c?"-"+c:(i?"-"+i:"")+(a?"-"+a:"")+(s?"-"+s:"")),l=r._listeners,u=Object.assign({},t);r.loggroup("‚ùì _fsmListeners "+f+" ("+l.length+" possible listeners)"),r.logger("with arguments template",u,e);try{n=l.every(function(t){var n,i=t.pattern,s=t.observer,a=s.fn,c=s.scope,l=s.options,p=Object.freeze(Object.assign(l?{options:l}:{},u)),g=!0;return(i instanceof RegExp?i.test(f):i===f)&&(n=[p].concat(e),r.logger("üí• %cExecuting listener : %s with arguments","color:red;font-style:italic",a.toString(),n),g=a.apply(c,n)),g||o})}finally{r.logger('_fsmListeners "%s" returns : %c%s',f,n,"color:"+(n?"green":"red")+";font-weight:bold"),r.loggroup()}return n},t.prototype.recoverPendingTransition=function(){this._pendingTransition=!1},t.prototype.isInTransition=function(){return this._pendingTransition},t.prototype.trigger=function(t){var e=1;if(this.isLocked()){if(!this.testLock(arguments[1]))return this.reason="Trigger is forbidden by a lock",!1;e=2}if(this._pendingTransition)return this.reason="Cannot trigger '"+arguments[e]+"' : previous transition is not completed",!1;this._pendingTransition=!0;for(var r=arguments.length,o=[];e<r;++e)o.push(arguments[e]);var i=function(t,e,r){var o=t._current,i=t._fromStates[o][e],s=!0,a=t._private.justListen;if(r=r||[],t.reason=null,!i)return t.reason="Cannot trigger '"+e+"' : undefined transition in current state '"+o+"'",!1;var c=i.to,f=i.options,l={event:e,from:o},u={state:o},p={state:c};c&&(l.to=c);function g(e,n,o){t.loggroup('‚ùì‚ùì Listeners "'+e+'"'),t.loggroup("‚ùì in configs ("+(o?o.length:0)+" functions)"),n.step=e;var i,s,c={};f&&(c.options=f);try{c=Object.freeze(Object.assign(c,n)),s=[c].concat(r),i=!o||o.every(function(n){return t.logger("üí• %cExecuting FSM %s : %s with arguments","color:red;font-style:italic",e,n.toString(),s),!n||n.apply(t,s)})}finally{t.loggroup(),a?t._fsmListeners(n,r):i=i&&t._fsmListeners(n,r),t.loggroup(),t.logger('Listeners "%s" returns : %c%s',e,"color:"+(i?"green":"red")+";font-weight:bold",i)}return i}function h(){return g("dont",l,i.dont)}var y="Transition "+e;t.loggroup('‚ö° TRIGGER TRANSITION "'+e+'" : from "'+o+'" to "'+c+'"'),t.logger("TRANSITION",i),t.logger("ARGUMENTS",r),t.logTime(y);try{if(!0!==g("before",l,i.before))throw"before cancelled the transition";if(!0!==g("guard",l,i.guard))throw h(),"guard cancelled the transition";if(c){if(!0!==g("exit",u,t._states[o].exit))throw h(),"exit cancelled the transition";t._actions={}}g("do",l,i.do),c&&(n(t,c,e),g("entry",p,t._states[c].entry))}catch(e){t.logerror(e),t.reason=e,s=!1}finally{try{g("after",l,i.after)}catch(e){t.logerror(e),t.reason={error:e,step:"after"},s=!1}t.loggroup(),t.logTimeEnd(y),t.logger("üîµ The transition returns => %c%s (reason : %o)","color:"+(s?"green":"red")+";font-weight:bold",s,t.reason),t.logger('üîµ Current state is "%c%s%c". Available events : "%s".',"color:blue;font-weight:bold",t._current,"",t.availEvents().join('","'))}return s}(this,t,o);return this._pendingTransition=!1,i},t.prototype.t=t.prototype.trigger,Object.defineProperty(t.prototype,"debug",{set:function(t){this._debug=!!this.logger&&!!(t&&console&&console.log&&console.time&&console.timeEnd)},get:function(){return this._debug}}),t.prototype.logger=function(){if(this._debug){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console.log.apply(console,n)}},t.prototype.logerror=function(){if(this._debug){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console[console.error?"error":"log"].apply(console,n),console.trace()}},t.prototype.loggroup=function(){if(this._debug)if(arguments.length){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console.groupCollapsed?console.groupCollapsed.apply(console,n):console.group&&console.group.apply(console,n)}else console.groupEnd&&console.groupEnd()},t.prototype.logTime=function(t){this._debug&&console.time(t)},t.prototype.logTimeEnd=function(t){this._debug&&console.timeEnd(t)},t});